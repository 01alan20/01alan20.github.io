<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SG Condo ROI Explorer</title>

  <!-- CSV loader & charting -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <!-- DataTables v2 (jQuery‑free) for sortable / searchable table -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

  <style>
    :root{
      --accent:#0062ff;--bg:#f8f9fa;--txt:#1a1a1a;--muted:#6c757d
    }
    @media(prefers-color-scheme:dark){:root{--accent:#4dabf7;--bg:#1b1b1b;--txt:#f1f1f1;--muted:#9a9a9a}}

    html,body{margin:0;padding:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:var(--bg);color:var(--txt)}
    h1{margin:1rem 0;text-align:center;font-size:1.8rem}
    #controls{max-width:960px;margin:0 auto 1rem;display:flex;gap:1rem;flex-wrap:wrap;justify-content:center}
    #controls label{font-weight:600;font-size:.9rem;margin-right:.3rem}
    #controls input{padding:.35rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:4px;width:120px}
    button{padding:.45rem 1rem;font-size:1rem;border:none;border-radius:4px;background:var(--accent);color:#fff;cursor:pointer}
    button:hover{filter:brightness(0.95)}
    #wrap{max-width:960px;margin:0 auto 2rem}
    #projTable{width:100% !important;border-collapse:collapse;background:#fff}
    #projTable thead th{border-bottom:2px solid #ddd}
    #chart{height:460px;margin-top:2rem;border:1px solid #ddd;border-radius:8px;background:#fff}
    .dt-search{margin-bottom:.5rem}
  </style>
</head>
<body>
  <h1>Singapore Condo Investment ROI Explorer</h1>

  <div id="controls">
    <div>
      <label for="sizeIn">Size (sqm)</label>
      <input id="sizeIn" type="number" value="60" min="20" max="300" step="1">
    </div>
    <div>
      <label for="budgetIn">Budget (SGD)</label>
      <input id="budgetIn" type="number" value="800000" step="10000" min="0">
    </div>
    <button id="applyBtn">Apply</button>
  </div>

  <div id="wrap">
    <table id="projTable" class="display compact"></table>
    <div id="chart" hidden>
      <p style="text-align:center;padding-top:200px;color:var(--muted)">Select a project row to view price & rent trends</p>
    </div>
  </div>

<script>
/* ------------------- 1.  Load CSV ------------------ */
Papa.parse("pmi_roi_agg.csv", {
  download:true, header:true, dynamicTyping:true,
  complete: ({data}) => init(data.filter(r=>r.project))
});

function init(rows){
  // derive helper fields once
  const YEARS = [2020,2021,2022,2023,2024,2025];
  rows.forEach(r=>{
    r.last_buy = r.avg_buy_2025 ?? NaN;
    r.roi = (r.avg_buy_2020 && r.avg_buy_2025) ? ((r.avg_buy_2025 - r.avg_buy_2020) / r.avg_buy_2020 * 100).toFixed(1) : "";
  });

  /* ------------ 2. Build DataTable -------------- */
  const table = new DataTable('#projTable', {
    data: rows,
    paging: false,
    columns: [
      {title:'Project',  data:'project'},
      {title:'District', data:'district'},
      {title:'Last Buy Price', data:'last_buy', render:d=> d ? '$'+(+d).toLocaleString() : ''},
      {title:'ROI 20‑25', data:'roi', render:d=> d? d+'%' : ''}
    ],
    order:[[2,'desc']],
    layout:{top:'search'} // enable built‑in search box
  });

  /* -------- 3.  Row‑click => plot ------------- */
  document.querySelector('#projTable tbody').addEventListener('click',  e=>{
    const tr = e.target.closest('tr');
    if(!tr) return;
    const rowData = table.row(tr).data();
    drawChart(rowData);
  });

  /* -------- 4.  Filters (size / budget)  -------- */
  document.getElementById('applyBtn').onclick = ()=>{
    const size   = +document.getElementById('sizeIn').value || 0;
    const budget = +document.getElementById('budgetIn').value || 0;

    // quick bucket parser → [lo,hi]
    const pass = r=>{
      const m = (r.area_bucket||'').split('-').map(Number);
      const sizeOk   = !size   || (m[0] <= size && size <= m[1]);
      const budgetOk = !budget || r.last_buy <= budget;
      return sizeOk && budgetOk;
    };

    const filtered = rows.filter(pass);
    table.clear();
    table.rows.add(filtered).draw();
  };

  /* -------------- 5. Chart helper ---------------- */
  function drawChart(r){
    const buy  = YEARS.map(y=>r['avg_buy_'+y]);
    const rent = YEARS.map(y=>r['avg_rent_'+y]);

    Plotly.newPlot('chart',[
      {x:YEARS, y:buy,  name:'Avg Buy Price',  mode:'lines+markers', yaxis:'y1'},
      {x:YEARS, y:rent, name:'Avg Rent',       mode:'lines+markers', yaxis:'y2'}
    ],{
      title:r.project + ' ('+(r.area_bucket||'‑')+' sqm)',
      margin:{t:40,l:50,r:50,b:50},
      xaxis:{dtick:1,title:'Year'},
      yaxis:{title:'Avg Buy Price (SGD)', tickprefix:'$'},
      yaxis2:{title:'Avg Monthly Rent (SGD)', overlaying:'y', side:'right', tickprefix:'$'}
    },{responsive:true});

    document.getElementById('chart').hidden = false;
  }
}
</script>
</body>
</html>
