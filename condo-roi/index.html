<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quick Condo Search</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<style>
body{font-family:system-ui,-apple-system,sans-serif;margin:0;padding:2rem;background:#f8f9fa;color:#222}
h1{margin-top:0} label{display:block;margin:.5rem 0 .25rem;font-weight:600}
input{padding:.4rem .6rem;font-size:1rem;width:100%;max-width:200px}
#results{margin-top:1.5rem} table{border-collapse:collapse;width:100%;max-width:800px;margin-top:.5rem}
th,td{border:1px solid #ccc;padding:.35rem .6rem;text-align:left} th{background:#007bff;color:#fff}
tr:nth-child(even){background:#eef2f8}
</style>
</head>
<body>
<h1>Quick Condo Search</h1>

<label>Desired size (sqm) <input id="size" type="number" step="1" value="60"></label>
<label>Max price (SGD)    <input id="price" type="number" step="10000" value="800000"></label>
<button id="btn" disabled>Search</button>
<div id="results"></div>

<script>
const CSV_PATH = "pmi_roi_agg.csv";
let ROWS=[], COL={};   // COL will hold the header → code mapping

/* ---------- 1. fetch & parse ---------- */
fetch(CSV_PATH).then(r=>r.text()).then(txt=>{
  const {data} = Papa.parse(txt,{header:true,dynamicTyping:true,skipEmptyLines:true});
  if(!data.length){ document.getElementById('results').textContent="CSV parsed 0 rows"; return; }

  console.log("✔ first row object:", data[0]);

  // detect actual header names (case-sensitive)
  COL.project = Object.keys(data[0]).find(k=>k.toLowerCase()==="project");
  COL.bucket  = Object.keys(data[0]).find(k=>k.toLowerCase()==="area_bucket");
  COL.price   = Object.keys(data[0]).find(k=>k.toLowerCase().includes("most_recent_buy"));
  COL.roi     = Object.keys(data[0]).find(k=>k.toLowerCase()==="roi");

  if(!COL.project||!COL.bucket||!COL.price){ 
      document.getElementById('results').textContent="CSV headers not recognised.";
      return;
  }

  ROWS = data.filter(r => r[COL.project] && r[COL.price]);
  document.getElementById('btn').disabled = false;
}).catch(err=>{
  document.getElementById('results').textContent="Failed to load CSV: "+err;
});

/* ---------- 2. search ---------- */
document.getElementById('btn').onclick = ()=>{
  const size   = +document.getElementById('size').value;
  const budget = +document.getElementById('price').value;

  const bucketRange = b=>{
    if(!b) return [NaN,NaN];
    if(b.startsWith(">")) return [+b.slice(1), Infinity];
    const [lo,hi]=b.split("-").map(Number); return [lo,hi];
  };

  const match = r=>{
    const [lo,hi]=bucketRange(r[COL.bucket]);
    return lo<=size && size<=hi && r[COL.price]<=budget;
  };

  const list = ROWS.filter(match);

  const out  = document.getElementById('results');
  if(!list.length){ out.textContent="No matching units."; return; }

  let html=`<p>Found ${list.length} units:</p><table><tr>
            <th>Project</th><th>Size bucket</th><th>Last buy price</th><th>ROI %</th></tr>`;
  list.slice(0,100).forEach(r=>{
    html+=`<tr><td>${r[COL.project]}</td><td>${r[COL.bucket]}</td>
               <td>${Number(r[COL.price]).toLocaleString()}</td>
               <td>${r[COL.roi]!=null?Number(r[COL.roi]).toFixed(2):""}</td></tr>`;
  });
  out.innerHTML=html+"</table>";
};
</script>
</body>
</html>
