<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Condo quick search</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<style>
body{font-family:system-ui,-apple-system,sans-serif;margin:0;padding:2rem;background:#f8f9fa;color:#222}
h1{margin-top:0} label{display:block;margin:.6rem 0 .25rem;font-weight:600}
select,input{padding:.4rem .6rem;font-size:1rem;width:100%;max-width:220px}
button{margin-top:.7rem;padding:.45rem .9rem;font-size:1rem}
#results{margin-top:1.6rem}
table{border-collapse:collapse;width:100%;max-width:820px;margin-top:.8rem}
th,td{border:1px solid #ccc;padding:.35rem .6rem;text-align:left}
th{background:#007bff;color:#fff} tr:nth-child(even){background:#eef2f8}
</style>
</head>
<body>

<h1>Quick Condo Search</h1>

<label> Size bucket
  <select id="bucket" disabled><option>Loading…</option></select>
</label>

<label> Max price (SGD)
  <input id="price" type="number" step="10000" value="800000">
</label>

<button id="btn" disabled>Search</button>

<div id="results"></div>

<script>
const CSV_PATH = "pmi_roi_agg.csv";      // file sits in same folder
let ROWS = [];

fetch(CSV_PATH)
  .then(r => r.text())
  .then(txt => {
      const {data} = Papa.parse(txt,{header:true,dynamicTyping:true,skipEmptyLines:true});
      ROWS = data.filter(r => r.project && r.most_recent_buy && r.area_bucket);

      // populate size-bucket dropdown
      const buckets = [...new Set(ROWS.map(r => r.area_bucket))].sort((a,b)=>{
          // numeric sort by lower bound if possible
          const na = parseFloat(a), nb = parseFloat(b);
          return isNaN(na)||isNaN(nb) ? a.localeCompare(b) : na-nb;
      });
      const sel = document.getElementById('bucket');
      sel.innerHTML = buckets.map(b=>`<option value="${b}">${b}</option>`).join("");
      sel.disabled = false;
      document.getElementById('btn').disabled = false;
  })
  .catch(err => document.getElementById('results').textContent =
        "Failed to load CSV: "+err);

/* ---------- helper: convert bucket → [lo,hi] ----------- */
function range(bucket){
  if(bucket.startsWith(">")) return [+bucket.slice(1), Infinity];
  const [lo,hi]=bucket.split("-").map(Number);
  return [lo,hi];
}

/* ---------- search ---------- */
document.getElementById('btn').onclick = ()=>{
  const bucket = document.getElementById('bucket').value;
  const [lo,hi] = range(bucket);
  const budget  = +document.getElementById('price').value || Infinity;

  const matches = ROWS.filter(r=>{
      const [blo,bhi]=range(r.area_bucket);
      return blo===lo && bhi===hi && r.most_recent_buy<=budget;
  });

  const out = document.getElementById('results');
  if(!matches.length){ out.textContent="No matching units."; return; }

  let html=`<p>Found ${matches.length} units in ${bucket} sqm bucket:</p><table><tr>
            <th>Project</th><th>Bucket</th><th>Last buy price</th><th>ROI %</th></tr>`;
  matches.slice(0,500).forEach(r=>{
     html+=`<tr><td>${r.project}</td><td>${r.area_bucket}</td>
              <td>${Number(r.most_recent_buy).toLocaleString()}</td>
              <td>${r.ROI!=null?Number(r.ROI).toFixed(2):""}</td></tr>`;
  });
  out.innerHTML=html+"</table>";
};
</script>
</body>
</html>
